<!DOCTYPE html>
<html>
<head>
<title>webauthn.html</title>
<style type="text/css">
body {
	font-family: sans-serif;
}
</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));
DOMContentLoaded.then(() => $("#register").click(register));
DOMContentLoaded.then(() => $("#authenticate").click(authenticate));

function getRandomChallenge() {
	var array = new Uint8Array(32);
	crypto.getRandomValues(array);
	return Promise.resolve(array);
}

var credentialsResponse;

var authenticatorAttestationResponse;
var authenticatorAssertionResponse;

function encodeArray(array) {
	return btoaUrlSafe(Array.from(new Uint8Array(array), t => String.fromCharCode(t)).join(""));
}

function replacer(k,v) {
	if(v && v.constructor === Uint8Array) {
		return encodeArray(v);
	}
	if(v && v.constructor === ArrayBuffer) {
		return encodeArray(v);
	}
	return v;
}

function decodeAuthenticatorData(data) {
	if(data.constructor === Uint8Array) {
		data = data.buffer.slice(data.byteOffset, data.byteLength + data.byteOffset);
	}
	if(data.constructor !== ArrayBuffer) throw "Invalid argument: " + data.constructor;
	var view = new DataView(data);
	var offset = 0;
	var rpIdHash = view.buffer.slice(offset, offset + 32); offset += 32;
	var flags = view.getUint8(offset); offset += 1;
	var signCount = view.getUint32(offset, false); offset += 4;
	var authenticatorData = {
		rpIdHash: rpIdHash,
		flags: {
			value: flags,
			up: (flags & 0x01) != 0,
			uv: (flags & 0x04) != 0,
			at: (flags & 0x40) != 0,
			ed: (flags & 0x80) != 0,
		},
		signCount: signCount,
	};
	// attestedCredentialData 
	if(authenticatorData.flags.at) {
		var aaguid = view.buffer.slice(offset, offset + 16); offset += 16;
		var credentialIdLength = view.getUint16(offset, false); offset += 2;
		var credentialId = view.buffer.slice(offset, offset + credentialIdLength); offset += credentialIdLength;
		var credentialPublicKey = view.buffer.slice(offset);
		authenticatorData.attestedCredentialData = {
			aaguid: aaguid,
			credentialId: credentialId,
			credentialPublicKey: credentialPublicKey,
		};
	}
	return authenticatorData;
}

function register() {
	var challenge_promise = getRandomChallenge();
	var name = "hello@example.com";
	var displayName = "Hello Example";
	var userid = Uint8Array.from(name, t => t.charCodeAt(0));
	// https://w3c.github.io/webauthn/#dictdef-publickeycredentialcreationoptions
	var createParams_promise = challenge_promise.then(challenge => {
		return {
			"publicKey": {
				"rp":{
					"name":location.origin,
					"id":location.host,
				},
				"user":{
					"id":userid,
					"name":name,
					"displayName":displayName,
				},
				"challenge":challenge,
				"pubKeyCredParams":[ 
					{type: "public-key", alg: -7},
					{type: "public-key", alg: -257},
				],
				"timeout":30000,
				"excludeCredentials":[],
				"authenticatorSelection":{
					//"authenticatorAttachment":"platform",
					//"requireResidentKey":false,
					//"userVerification":"preferred",
				},
				//"attestation":"direct",
				"attestation":"none",
			}
		};
	});
	createParams_promise.then(createParams => $("#authenticatorAttestationRequest").text(JSON.stringify(createParams, replacer, 2)));
	var create_promise = createParams_promise.then(createParams => navigator.credentials.create(createParams));
	Promise.all([challenge_promise, create_promise])
		.then(all => {
			var challenge = all[0];
			var credentialsResponse = all[1];
			var authenticatorAttestationResponse = credentialsResponse.response;
			var attestationObject = CBOR.decode(authenticatorAttestationResponse.attestationObject);
			// https://w3c.github.io/webauthn/#iface-authenticatorattestationresponse
			return {
				request: {
					challenge: challenge,
				},
				id: credentialsResponse.id,
				type: credentialsResponse.type,
				rawId: credentialsResponse.rawId,
				response: {
					rawClientDataJSON: authenticatorAttestationResponse.clientDataJSON,
					clientDataJSON: JSON.parse(Array.from(new Uint8Array(authenticatorAttestationResponse.clientDataJSON), t => String.fromCharCode(t)).join("")),
					rawAttestationObject: authenticatorAttestationResponse.attestationObject,
					attestationObject: attestationObject,
					authenticatorData: decodeAuthenticatorData(attestationObject.authData),
				},
			};
		})
		.then(obj => $("#authenticatorAttestationResponse").text(JSON.stringify(obj, replacer, 2)))
		.catch(e => console.error("credentials.create " + e));
	create_promise.then(cred => credentialsResponse = cred);
	create_promise.then(cred => authenticatorAttestationResponse = cred.response);
}

function authenticate() {
	var challenge_promise = getRandomChallenge();
	// https://w3c.github.io/webauthn/#dictdef-publickeycredentialrequestoptions
	var requestParams_promise = challenge_promise.then(challenge => {
		return {
			"publicKey": {
				"challenge":challenge,
				"timeout":30000,
				"rpId":location.host,
				"allowCredentials":[
					{
						id: credentialsResponse.rawId,
						type: credentialsResponse.type,
					},
				],
				//"userVerification":"preferred",
			}
		};
	});
	requestParams_promise.then(requestParams => $("#authenticatorAssertionRequest").text(JSON.stringify(requestParams, replacer, 2)));
	var request_promise = requestParams_promise.then(requestParams => navigator.credentials.get(requestParams));
	Promise.all([challenge_promise, request_promise])
		.then(all => {
			var challenge = all[0];
			var credentialsResponse = all[1];
			var authenticatorAssertionResponse = credentialsResponse.response;
			// https://w3c.github.io/webauthn/#iface-authenticatorassertionresponse
			return {
				request: {
					challenge: challenge,
				},
				id: credentialsResponse.id,
				type: credentialsResponse.type,
				rawId: credentialsResponse.rawId,
				response: {
					rawClientDataJSON: authenticatorAssertionResponse.clientDataJSON,
					clientDataJSON: JSON.parse(Array.from(new Uint8Array(authenticatorAssertionResponse.clientDataJSON), t => String.fromCharCode(t)).join("")),
					rawAuthenticatorData: authenticatorAssertionResponse.authenticatorData,
					authenticatorData: decodeAuthenticatorData(authenticatorAssertionResponse.authenticatorData),
					signature: authenticatorAssertionResponse.signature,
					userHandle: authenticatorAssertionResponse.userHandle,
				},
			};
		})
		.then(obj => $("#authenticatorAssertionResponse").text(JSON.stringify(obj, replacer, 2)))
		.catch(e => console.error("credentials.get " + e));
	request_promise.then(cred => credentialsResponse = cred);
	request_promise.then(cred => authenticatorAssertionResponse = cred.response);
}
</script>
</head>
<body>

<table>

<tr>
<td>
<div><input id="register" value="credentials.create" type="button" /></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#createCredential">Create a New Credential</a></div>
<div><a href="https://w3c.github.io/webappsec-credential-management/#dom-credentialscontainer-create">navigator.credentials.create()</a></div>
<div><a href="https://w3c.github.io/webauthn/#op-make-cred">authenticatorMakeCredential</a></div>
</td>
</tr>

<tr>
<td>
<div><textarea id="authenticatorAttestationRequest" rows="8" cols="80"></textarea></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#credentialcreationoptions-extension">CredentialCreationOptions</a></div>
<div><a href="https://w3c.github.io/webauthn/#dictdef-publickeycredentialcreationoptions">PublicKeyCredentialCreationOptions</a></div>
</td>
</tr>

<tr>
<td>
<div><textarea id="authenticatorAttestationResponse" rows="8" cols="80"></textarea></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#publickeycredential">PublicKeyCredential</a></div>
<div><a href="https://w3c.github.io/webauthn/#authenticatorattestationresponse">AuthenticatorAttestationResponse</a></div>
</td>
</tr>

<tr>
<td>
<div><input id="authenticate" value="credentials.get" type="button" /></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#getAssertion">Use an Existing Credential to Make an Assertion</a></div>
<div><a href="https://w3c.github.io/webappsec-credential-management/#dom-credentialscontainer-get">navigator.credentials.get()</a></div>
<div><a href="https://w3c.github.io/webauthn/#op-get-assertion">authenticatorGetAssertion</a></div>
</td>
</tr>

<tr>
<td>
<div><textarea id="authenticatorAssertionRequest" rows="8" cols="80"></textarea></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#credentialrequestoptions-extension">CredentialRequestOptions</a></div>
<div><a href="https://w3c.github.io/webauthn/#dictdef-publickeycredentialrequestoptions">PublicKeyCredentialRequestOptions</a></div>
</td>
</tr>

<tr>
<td>
<div><textarea id="authenticatorAssertionResponse" rows="8" cols="80"></textarea></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/#publickeycredential">PublicKeyCredential</a></div>
<div><a href="https://w3c.github.io/webauthn/#authenticatorassertionresponse">AuthenticatorAssertionResponse</a></div>
</td>
</tr>

<tr>
<td>
<div></div>
</td>
<td>
<div><a href="https://w3c.github.io/webauthn/">https://w3c.github.io/webauthn/</a></div>
</td>
</tr>

</table>


</body>
</html>