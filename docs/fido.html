<!DOCTYPE html>
<html>
<head>
<title>fido.html</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="db.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));
DOMContentLoaded.then(() => $("#generateKey").click(generateKey));
DOMContentLoaded.then(() => $("#sign").click(sign));
DOMContentLoaded.then(() => $("#register").click(register));
DOMContentLoaded.then(() => $("#authenticate").click(authenticate));
const S256 = { name: "SHA-256" };
const RS256 = {
    name: "RSASSA-PKCS1-v1_5",
    modulusLength: 2048,
    publicExponent: new Uint8Array([1, 0, 1]),
    hash: S256
};
function generateKey() {
    var db_promise = db_delete("crypto")
        .then(() => db_create("crypto", db => db.createObjectStore("KeyPair", { keyPath: "id" })));
    var key_promise = crypto.subtle.generateKey(RS256, false, ["sign", "verify"]);
    var jwk_promise = key_promise.then(key => crypto.subtle.exportKey("jwk", key.publicKey))
        .then(jwk => $("#jwk").text(JSON.stringify(jwk, 0, 2)));
    var put_promise = Promise.all([db_promise, key_promise])
        .then(all => db_put(all[0], "KeyPair", { id: 0, publicKey: all[1].publicKey, privateKey: all[1].privateKey }))
        .then(db_close);
    Promise.all([db_promise, key_promise, jwk_promise, put_promise])
        .catch(error => console.error("generateKey " + error));
}
function utf8(n) {
    n = n & 0xff;
    if(n & 0x80) {
        return String.fromCharCode(0xc0 | ((n >> 6) & 0x3), 0x80 | (n & 0x3f));
    } else {
        return String.fromCharCode(n);
    }
}
function sign() {
    var db_promise = db_open("crypto");
    var get_promise = db_promise.then(db => db_get(db, "KeyPair", 0));
    var key_promise = get_promise.then(item => item ? item.privateKey : Promise.reject("KeyPairNotFound"));
    var sign_promise = key_promise
        .then(privateKey => crypto.subtle.sign(RS256, privateKey, new Uint8Array(32)))
//        .then(signature => console.log("sign " + btoaUrlSafe(new Uint8Array(signature).map(t => utf8(t)).join(""))));
//        .then(signature => console.log("sign " + new Uint8Array(signature).map(t => String.fromCharCode(t & 0xff)).join("")));
//        .then(signature => console.log("sign " + new Uint8Array(signature)));
        .then(signature => console.log("sign " + btoaUrlSafe(Array.from(new Uint8Array(signature), t => String.fromCharCode(t)).join(""))));
    Promise.all([db_promise, get_promise, key_promise, sign_promise])
        .then(all => db_close(all[0]))
        .catch(error => console.error("sign " + error));
}
function register() {
}
function authenticate() {
}
</script>
</head>
<body>

<p>
<input id="generateKey" value="generateKey" type="button" />
</p>

<p>
<textarea id="jwk" rows="8" cols="80"></textarea>
</p>

<p>
<input id="sign" value="sign" type="button" />
</p>

<p>
<textarea id="signature" rows="8" cols="80"></textarea>
</p>

<p>
<input id="register" value="register" type="button" />
</p>

<p>
<input id="authenticate" value="authenticate" type="button" />
</p>

</body>
</html>