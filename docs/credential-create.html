<!DOCTYPE html>
<html>
<head>
<title>credential-create.html</title>
<link rel="stylesheet" type="text/css" href="credential.css" />
<style type="text/css">
</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="webauthn.js"></script>
<script type="text/javascript" src="settings.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var settings = readSettings();
var authenticatorSelection = {};
var attestation = "";

function GetPublicKeyCredentialCreationOptions() {
	var challenge_promise = getRandomChallenge();
	return challenge_promise.then(challenge => {
		var publicKeyCredentialCreationOptions = {
			"publicKey": {
				"rp": settings.rp,
				"user": settings.user,
				"challenge":challenge,
				"pubKeyCredParams":[ 
					{"type": "public-key", "alg": -7},
					{"type": "public-key", "alg": -257},
				],
				"timeout":30000,
			}
		};
		publicKeyCredentialCreationOptions.publicKey.user.id = Uint8Array.from(publicKeyCredentialCreationOptions.publicKey.user.name, t => t.charCodeAt(0));
		if(authenticatorSelection.authenticatorAttachment == "") delete authenticatorSelection.authenticatorAttachment;
		if(authenticatorSelection.requireResidentKey == null) delete authenticatorSelection.requireResidentKey;
		if(authenticatorSelection.userVerification == "") delete authenticatorSelection.userVerification;
		if(Object.keys(authenticatorSelection).length > 0) publicKeyCredentialCreationOptions.publicKey.authenticatorSelection = authenticatorSelection;
		if(attestation != "") publicKeyCredentialCreationOptions.publicKey.attestation = attestation;
		return publicKeyCredentialCreationOptions;
	});
}

Promise.all([DOMContentLoaded,PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()])
	.then(all => $("#isUserVerifyingPlatformAuthenticatorAvailable").toggleClass("error", !all[1]).val(all[1]));
	
var publicKeyCredentialCreationOptions_promise = null;

function InitializeDisplay() {
	$("#publicKey\\.rp\\.name").val(settings.rp.name);
	$("#publicKey\\.rp\\.id").val(settings.rp.id);
	$("#publicKey\\.user\\.name").val(settings.user.name).bind("input", e => settings.user.name = $(e.target).val()).bind("input", ShowPublicKeyCredentialCreationOptions);
	$("#publicKey\\.user\\.displayName").val(settings.user.displayName).bind("input", e => settings.user.displayName = $(e.target).val()).bind("input", ShowPublicKeyCredentialCreationOptions);
	addOptions($("#publicKey\\.authenticatorSelection\\.authenticatorAttachment"), ["","platform","cross-platform"]).bind("change", e => authenticatorSelection.authenticatorAttachment = $(e.target).val()).bind("change", ShowPublicKeyCredentialCreationOptions);
	addOptions($("#publicKey\\.authenticatorSelection\\.requireResidentKey"), ["","true","false"]).bind("change", e => authenticatorSelection.requireResidentKey = toBoolean($(e.target).val())).bind("change", ShowPublicKeyCredentialCreationOptions);
	addOptions($("#publicKey\\.authenticatorSelection\\.userVerification"), ["","required","preferred","discouraged"]).bind("change", e => authenticatorSelection.userVerification = $(e.target).val()).bind("change", ShowPublicKeyCredentialCreationOptions);
	addOptions($("#publicKey\\.attestation"), ["","none","direct","indirect"]).bind("change", e => attestation = $(e.target).val()).bind("change", ShowPublicKeyCredentialCreationOptions);
	$("#credentials\\.create").bind("click", CreatePublicKeyCredential);
}

function ShowPublicKeyCredentialCreationOptions() {
	publicKeyCredentialCreationOptions_promise = GetPublicKeyCredentialCreationOptions();
	publicKeyCredentialCreationOptions_promise
		.then(publicKeyCredentialCreationOptions => $("#PublicKeyCredentialCreationOptions").val(JSON.stringify(publicKeyCredentialCreationOptions, replacer, 2)));
}

var publicKeyCredential_promise = Promise.reject();
var publicKeyCredential = null;
var clientDataJSON_promise = Promise.reject();
var clientDataJSON = null;
var attestationObject_promise = Promise.reject();
var attestationObject = null;
var authData_promise = Promise.reject();
var authData = null;
var credentialPublicKey_promise = Promise.reject();
var credentialPublicKey = null;

function CreatePublicKeyCredential() {
	saveSettings(settings);
	
	$("#PublicKeyCredential").val("");
	$("#clientDataJSON").val("");
	$("#attestationObject").val("");
	$("#authData").val("");
	$("#credentialPublicKey").val("");
	
	publicKeyCredential_promise = publicKeyCredentialCreationOptions_promise
		.then(publicKeyCredentialCreationOptions => navigator.credentials.create(publicKeyCredentialCreationOptions));
		
	DecodePublicKeyCredential();
}

function DecodePublicKeyCredential() {
	publicKeyCredential_promise
		.then(credential => $("#PublicKeyCredential").removeClass("error").val(JSON.stringify(credential, replacer, 2)))
		.catch(e => $("#PublicKeyCredential").addClass("error").val(e))
	publicKeyCredential_promise.then(credential => publicKeyCredential = credential);

	clientDataJSON_promise = publicKeyCredential_promise
		.then(credential => JSON.parse(Array.from(new Uint8Array(credential.response.clientDataJSON), t => String.fromCharCode(t)).join("")));
	clientDataJSON_promise.then(value => $("#clientDataJSON").val(JSON.stringify(value, replacer, 2)));
	clientDataJSON_promise.then(value => clientDataJSON = value);
	
	attestationObject_promise = publicKeyCredential_promise
		.then(credential => CBOR.decode(credential.response.attestationObject));
	attestationObject_promise.then(value => $("#attestationObject").val(JSON.stringify(value, replacer, 2)));
	attestationObject_promise.then(value => attestationObject = value);

	authData_promise = attestationObject_promise
		.then(value => decodeAuthenticatorData(value.authData));
	authData_promise.then(value => $("#authData").val(JSON.stringify(value, replacer, 2)));
	authData_promise.then(value => authData = value);

	credentialPublicKey_promise = authData_promise
		.then(value => CBOR.decode(value.attestedCredentialData.credentialPublicKey))
		.then(value => coseToJwk(value));
	credentialPublicKey_promise.then(value => $("#credentialPublicKey").val(JSON.stringify(value, replacer, 2)));
	credentialPublicKey_promise.then(value => credentialPublicKey = value);

    Promise.all([publicKeyCredential_promise,credentialPublicKey_promise])
		.then(all => {
			addCredential(settings, settings.user, all[0].id, all[1]);
		});	
}

DOMContentLoaded.then(() => InitializeDisplay());
DOMContentLoaded.then(() => ShowPublicKeyCredentialCreationOptions());
</script>
</head>
<body>

<table>
<tr><td>PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()</td><td><input type="text" readonly="readonly" id="isUserVerifyingPlatformAuthenticatorAvailable" /></td></tr>
<tr><td>PublicKeyCredentialCreationOptions</td></tr>
<tr><td>publicKey.rp.name</td><td><input type="text" readonly="readonly" id="publicKey.rp.name" /></td></tr>
<tr><td>publicKey.rp.id</td><td><input type="text" readonly="readonly" id="publicKey.rp.id" /></td></tr>
<tr><td>publicKey.user.name</td><td><input type="text" id="publicKey.user.name" /></td></tr>
<tr><td>publicKey.user.displayName</td><td><input type="text" id="publicKey.user.displayName" /></td></tr>
<tr><td>publicKey.authenticatorSelection.authenticatorAttachment</td><td><select id="publicKey.authenticatorSelection.authenticatorAttachment"></select></td></tr>
<tr><td>publicKey.authenticatorSelection.requireResidentKey</td><td><select id="publicKey.authenticatorSelection.requireResidentKey"></select></td></tr>
<tr><td>publicKey.authenticatorSelection.userVerification</td><td><select id="publicKey.authenticatorSelection.userVerification"></select></td></tr>
<tr><td>publicKey.attestation</td><td><select id="publicKey.attestation"></select></td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredentialCreationOptions" rows="16" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><input id="credentials.create" type="button" value="credentials.create()" /></td></tr>
<tr><td><a href="credential-get.html">credential-get.html</a></td></tr>
<tr><td>PublicKeyCredential</td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredential" rows="10" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>clientDataJSON</td></tr>
<tr><td colspan="2"><textarea id="clientDataJSON" rows="8" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>attestationObject</td></tr>
<tr><td colspan="2"><textarea id="attestationObject" rows="11" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>authData</td></tr>
<tr><td colspan="2"><textarea id="authData" rows="12" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>credentialPublicKey</td></tr>
<tr><td colspan="2"><textarea id="credentialPublicKey" rows="7" cols="80" readonly="readonly"></textarea></td></tr>
</table>

</body>
</html>
