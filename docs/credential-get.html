<!DOCTYPE html>
<html>
<head>
<title>credential-get.html</title>
<style type="text/css">
body {
	font-family: sans-serif;
}
.error {
	color:red;
}
textarea {
	white-space: pre;
	word-wrap: normal;
	word-break: normal;
}
</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="webauthn.js"></script>
<script type="text/javascript" src="settings.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var settings = readSettings();
var allowCredentials = "";
var userVerification = "";

function GetPublicKeyCredentialRequestOptions() {
	var challenge_promise = getRandomChallenge();
	return challenge_promise.then(challenge => {
		var publicKeyCredentialRequestOptions = {
			"publicKey": {
				"challenge":challenge,
				"timeout":30000,
				"rpId":settings.rp.id,
			}
		};
		if(allowCredentials != "") {
			publicKeyCredentialRequestOptions.publicKey.allowCredentials = [
				{
					"id":Uint8Array.from(atobUrlSafe(allowCredentials), t => t.charCodeAt(0)),
					"type":"public-key",
				}
			];
		}
		if(userVerification != "") publicKeyCredentialRequestOptions.publicKey.userVerification = userVerification;
		return publicKeyCredentialRequestOptions;
	});
}

Promise.all([DOMContentLoaded,PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()])
	.then(all => $("#isUserVerifyingPlatformAuthenticatorAvailable").val(all[1]));

var publicKeyCredentialRequestOptions_promise = null;

function InitializeDisplay() {
	$("#publicKey\\.allowCredentials").empty();
	$("#publicKey\\.allowCredentials").append("<option>");
	for(var i in settings.credentials) {
		var cred = settings.credentials[i];
		var o = $("<option>")
			.attr({"value":cred.id})
			.text(cred.instant);
		$("#publicKey\\.allowCredentials").append(o);		
	}
	$("#publicKey\\.allowCredentials").bind("change", e => allowCredentials = $(e.target).val()).bind("change", ShowPublicKeyCredentialRequestOptions);
	addOptions($("#publicKey\\.userVerification"), ["","required","preferred","discouraged"]).bind("change", e => userVerification = $(e.target).val()).bind("change", ShowPublicKeyCredentialRequestOptions);
	$("#credentials\\.get").bind("click", RequestPublicKeyCredential);
}

function ShowPublicKeyCredentialRequestOptions() {
	publicKeyCredentialRequestOptions_promise = GetPublicKeyCredentialRequestOptions();
	publicKeyCredentialRequestOptions_promise
		.then(publicKeyCredentialRequestOptions => $("#PublicKeyCredentialRequestOptions").text(JSON.stringify(publicKeyCredentialRequestOptions, replacer, 2)));
}
	
var publicKeyCredential_promise = Promise.reject();
var publicKeyCredential = null;
var clientDataJSON_promise = Promise.reject();
var clientDataJSON = null;
var authenticatorData_promise = Promise.reject();
var authenticatorData = null;

function RequestPublicKeyCredential() {
	$("#PublicKeyCredential").text("");
	$("#clientDataJSON").text("");
	$("#authenticatorData").text("");

	publicKeyCredential_promise = publicKeyCredentialRequestOptions_promise
		.then(publicKeyCredentialRequestOptions => navigator.credentials.get(publicKeyCredentialRequestOptions));
		
	DecodePublicKeyCredential();
}

function DecodePublicKeyCredential() {
	publicKeyCredential_promise
		.then(credential => $("#PublicKeyCredential").removeClass("error").text(JSON.stringify(credential, replacer, 2)))
		.catch(e => $("#PublicKeyCredential").addClass("error").text(e))
	publicKeyCredential_promise.then(credential => publicKeyCredential = credential);

	clientDataJSON_promise = publicKeyCredential_promise
		.then(credential => JSON.parse(Array.from(new Uint8Array(credential.response.clientDataJSON), t => String.fromCharCode(t)).join("")));
	clientDataJSON_promise.then(value => $("#clientDataJSON").text(JSON.stringify(value, replacer, 2)));
	clientDataJSON_promise.then(value => clientDataJSON = value);

	authenticatorData_promise = publicKeyCredential_promise
		.then(credential => decodeAuthenticatorData(credential.response.authenticatorData));
	authenticatorData_promise.then(value => $("#authenticatorData").text(JSON.stringify(value, replacer, 2)));
	authenticatorData_promise.then(value => authenticatorData = value);
	
	jwk_promise = publicKeyCredential_promise
		.then(value => {
			for(var i in settings.credentials) {
				var cred = settings.credentials[i];
				if(cred.id == value.id) return cred.credentialPublicKey;
			}
			return Promise.reject("PublicKey not found: " + value.id);
		});
	jwk_promise.then(value => $("#credentialPublicKey").text(JSON.stringify(value, replacer, 2)));
	
	Promise.all([publicKeyCredential_promise,jwk_promise])
		.then(all => verifyAssertionSignature(all[0], all[1]))
		.catch(e => console.error("verifyAssertionSignature: error "+e))
		.then(result => console.log("verifyAssertionSignature: returns "+result));
}
	
DOMContentLoaded.then(() => InitializeDisplay());
DOMContentLoaded.then(() => ShowPublicKeyCredentialRequestOptions());	
</script>
</head>
<body>

<table>
<tr><td>PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()</td><td><input type="text" readonly="readonly" id="isUserVerifyingPlatformAuthenticatorAvailable" /></td></tr>
<tr><td>PublicKeyCredentialRequestOptions</td></tr>
<tr><td>publicKey.allowCredentials</td><td><select id="publicKey.allowCredentials"></select></td></tr>
<tr><td>publicKey.userVerification</td><td><select id="publicKey.userVerification"></select></td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredentialRequestOptions" rows="14" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><input id="credentials.get" type="button" value="credentials.get" /></td></tr>
<tr><td>PublicKeyCredential</td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredential" rows="12" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>clientDataJSON</td></tr>
<tr><td colspan="2"><textarea id="clientDataJSON" rows="8" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>authenticatorData</td></tr>
<tr><td colspan="2"><textarea id="authenticatorData" rows="11" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td>credentialPublicKey (from sessionStorage)</td></tr>
<tr><td colspan="2"><textarea id="credentialPublicKey" rows="7" cols="80" readonly="readonly"></textarea></td></tr>
</table>

</body>
</html>
