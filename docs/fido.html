<!DOCTYPE html>
<html>
<head>
<title>fido.html</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));
DOMContentLoaded.then(() => $("#register").click(register));
DOMContentLoaded.then(() => $("#authenticate").click(authenticate));

function getRandomChallenge() {
	var array = new Uint8Array(32);
	crypto.getRandomValues(array);
	return Promise.resolve(array);
}

var credentialsResponse;

var authenticatorAttestationResponse;
var authenticatorAssertionResponse;

function encodeArray(array) {
	return btoaUrlSafe(Array.of(new Uint8Array(array), t => String.fromCharCode(t)));
}

function register() {
	var challenge_promise = getRandomChallenge();
	var name = "hello@example.com";
	var userid = Uint8Array.from(name, t => t.charCodeAt(0));
	var createParams_promise = challenge_promise.then(challenge => ({
		"publicKey": {
			"rp":{
				"name":location.origin,
				"id":location.host,
			},
			"user":{
				"id":userid,
				"name":name,
				"displayName":name,
			},
			"challenge":challenge,
			"pubKeyCredParams":[ 
				{type: "public-key", alg: -7},
				{type: "public-key", alg: -257},
			],
			"timeout":30000,
			"excludeCredentials":[],
			"authenticatorSelection":{
				//"authenticatorAttachment":"platform",
				//"requireResidentKey":false,
				//"userVerification":"preferred",
			},
			"attestation":"direct",
		}
	}));
	//createParams_promise.then(createParams => console.log(JSON.stringify(createParams)));
	var create_promise = createParams_promise.then(createParams => navigator.credentials.create(createParams));
	create_promise
		.then(cred => ({
			id: cred.id,
			type: cred.type,
			rawId: encodeArray(cred.rawId),
			response: {
				clientDataJSON: encodeArray(cred.response.clientDataJSON),
				attestationObject: encodeArray(cred.response.attestationObject),
			},
		}))
		.then(obj => $("#authenticatorAttestationResponse").text(JSON.stringify(obj, 0, 2)))
		.catch(e => console.error("credentials.create " + e));
	create_promise.then(cred => credentialsResponse = cred);
	create_promise.then(cred => authenticatorAttestationResponse = cred.response);
}

function authenticate() {
	var challenge_promise = getRandomChallenge();
	var requestParams_promise = challenge_promise.then(challenge => ({
		"publicKey": {
			"challenge":challenge,
			"timeout":30000,
			"rpId":location.host,
			//"allowCredentials":[],
			//"userVerification":"preferred",
		}
	}));
	var request_promise = requestParams_promise.then(requestParams => navigator.credentials.get(requestParams));
	request_promise
		.then(cred => ({
			id: cred.id,
			type: cred.type,
			rawId: encodeArray(cred.rawId),
			response: {
				clientDataJSON: encodeArray(cred.response.clientDataJSON),
				authenticatorData: encodeArray(cred.response.authenticatorData),
				signature: encodeArray(cred.response.signature),
				userHandle: encodeArray(cred.response.userHandle),
			},
		}))
		.then(obj => $("#authenticatorAssertionResponse").text(JSON.stringify(obj, 0, 2)))
		.catch(e => console.error("credentials.get " + e));
	request_promise.then(cred => credentialsResponse = cred);
	request_promise.then(cred => authenticatorAssertionResponse = cred.response);
}
</script>
</head>
<body>

<p>
<input id="register" value="register" type="button" />
</p>

<p>
<textarea id="authenticatorAttestationResponse" rows="8" cols="80"></textarea>
</p>

<p>
<input id="authenticate" value="authenticate" type="button" />
</p>

<p>
<textarea id="authenticatorAssertionResponse" rows="8" cols="80"></textarea>
</p>

</body>
</html>