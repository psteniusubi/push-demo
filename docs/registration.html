<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1" />
<link href="/push-demo/256.png" rel="icon" type="image/png" />
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript" src="subscription.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", e => resolve()));

function do_subscribe(e) {
    var serviceWorker_promise = navigator.serviceWorker.register("/push-demo/worker.js")
        .then(reg => console.log("register " + reg));
    var Notification_promise = Notification.requestPermission()
        .then(permission => console.log("requestPermission " + permission));
    var info_promise = get_service_info();
    var pushManager_promise = navigator.serviceWorker.ready
        .then(serviceWorkerRegistration => serviceWorkerRegistration.pushManager);
    Promise.all([serviceWorker_promise, Notification_promise, info_promise, pushManager_promise])
        .then(() => {
            console.log("promise.all");
            info_promise.then(json => console.log("get_service_info " + JSON.stringify(json)));
            return pushManager_promise;
        })
        .then(pushManager => {
            console.log("pushManager " + pushManager); 
            return info_promise
                .then(json => pushManager.subscribe({
                    userVisibleOnly:true,
                    applicationServerKey:Uint8Array.from(atobUrlSafe(json.applicationServerKey), t => t.charCodeAt(0))
                }))
                .catch(error => {
                    console.error("pushManager.subscribe " + error);
                    return Promise.reject(error);
                });
        })
        .then(pushSubscription => {
            console.log("pushSubscription " + JSON.stringify(pushSubscription.toJSON()));
            return new_subscription($("#login_hint").val(), pushSubscription.toJSON());
        })
        .then(json => {
            console.log(JSON.stringify(json)); 
            location.assign("subscription.html#" + encode_location(json.subid));
        })
        .catch(error => {
            console.error("do_subscribe " + error);
            $("#error").text("subscription failed: " + error);
        });
}

DOMContentLoaded.then(() => $("#ok").click(do_subscribe));
</script>
</head>
<body>

<div>
<p>
Login: <input id="login_hint" type="text" value="hello@example.com" />
</p>
<p>
<input id="ok" type="button" value="OK" />
</p>
</div>

<div id="error" style="color:red"></div>

</body>
</html>