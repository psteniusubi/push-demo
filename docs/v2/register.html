<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="../base64url.js"></script>
<script type="text/javascript" src="encoders.js"></script>
<script type="text/javascript" src="db.js"></script>
<script type="text/javascript" src="crypto.js"></script>
<script type="text/javascript" src="fetch.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var openid_configuration_uri = "https://sso.example.com/.well-known/openid-configuration";
var client_configuration_promise = Promise.resolve({
    "client_id": "register",
    "client_secret": "register"
});

function get_client_configuration() {
    return client_configuration_promise;
}
var openid_configuration_promise = null;
function get_openid_configuration() {
    return openid_configuration_promise = openid_configuration_promise || http_get_json(openid_configuration_uri);
}

function OpenIDConnectClient(get_provider, get_client) {
    if(typeof get_provider !== "function") throw "illegal argument";
    if(typeof get_client !== "function") throw "illegal argument";
    const self = this;
    function issue_token_request(code) {
        console.log("issue_token_request(" + code + ")");    
        var token_response_promise = Promise.all([get_client(), get_provider()])
            .then(all => {
                var client = all[0];
                var provider = all[1];
                var headers = { "Content-Type": "application/x-www-form-urlencoded" };
                var body = "grant_type=authorization_code"
                    + "&code=" + encodeURIComponent(code)        
                    + "&client_id=" + encodeURIComponent(client.client_id)
                    + "&client_secret=" + encodeURIComponent(client.client_secret)
                    + "&redirect_uri=" + encodeURIComponent(location.origin + location.pathname);
                var request = new Request(provider.token_endpoint, {"method":"POST", "headers":headers, "body":body});
                return window.fetch(request)
                    .then(response => log_fetch(request, response))
                    .then(response => response.ok ? as_json(response) : http_reject(request, response));
            });
        token_response_promise.then(json => console.log(JSON.stringify(json)));
        return token_response_promise;
    };
    this.get_provider = get_provider;
    this.get_client = get_client;
    this.fetch = () => Promise.reject("not ready");
    this.ready = new Promise((resolve, reject) => {
        window.addEventListener(
            "authorization_code", 
            (e) => {
                console.log("authorization_code e.detail=" + e.detail.code);
                var token_response_promise = issue_token_request(e.detail.code);
                self.fetch = (input, init) => {
                    var request = new Request(input, init);
                    return token_response_promise
                        .then(token_response => {
                            console.log("OpenIDConnectClient.fetch Bearer=" + token_response.access_token);
                            request.headers.set("Authorization", "Bearer " + token_response.access_token);
                            return window.fetch(request)
                                .then(response => log_fetch(request, response));
                        });
                };
                token_response_promise.then(() => resolve(true));
            }, 
            {once: true}
        );
    });
}

OpenIDConnectClient.prototype.authorization_code = function(code) {
    window.dispatchEvent(new CustomEvent("authorization_code", {"detail": {"code": code}}));
}

OpenIDConnectClient.prototype.authentication_request = function() {
    Promise.all([this.get_client(), this.get_provider()])
        .then(all => {
            var client = all[0];
            var provider = all[1];
            var request = "client_id=" + encodeURIComponent(client.client_id)
                + "&redirect_uri=" + encodeURIComponent(location.origin + location.pathname)
                + "&response_type=code";
            location.assign(provider.authorization_endpoint + "?" + request);
        });
}

var client = new OpenIDConnectClient(get_openid_configuration, get_client_configuration);

if(location.search.startsWith("?")) {
    location.replace(location.pathname + "#" + location.search.substr(1));
} else if(/(#|&)code=([^&]*)(&|$)/.test(location.hash)) {
    var code = RegExp.$2;
    location.hash = "";
    // pass authorization_code to client
    client.authorization_code(code);
}

function login_click() {
    console.log("login_click");
    // send oidc authentication request
    client.authentication_request();
}

function registration_request() {
    return client.ready.then(() => {
        var request = new Request("https://api.example.com/v2/registration", {"method":"POST"});
        var promise = client.fetch(request)
            .then(response => response.ok ? as_json(response) : http_reject(request, response));
        promise
            .then(json => console.log("registration " + JSON.stringify(json)))
            .catch(e => console.error("registration_click " + e));
        Promise.all([promise,DOMContentLoaded])
            .then(all => $("#username").val(all[0].publicKey.user.name));
        return promise;
    }
}

var registration_request_promise = registration_request();

function register_click() {
    console.log("register_click");
}

DOMContentLoaded.then(() => $("#login").click(login_click));
DOMContentLoaded.then(() => $("#username").val("Wait.."));
DOMContentLoaded.then(() => $("#register").click(register_click));
</script>
</head>
<body>
<p><a href="https://psteniusubi.example.com/push-demo/v2/register.html">psteniusubi.example.com</a></p>
<p><a href="https://psteniusubi.example.com/push-demo/v2/register.html#code=123">psteniusubi.example.com#code=123</a></p>
<p><input type="button" id="login" value="Login" /></p>
<p><input type="text" id="username" /></p>
<p><input type="button" id="register" value="Register" /></p>
</body>
</html>
